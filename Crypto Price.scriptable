{
  "always_run_in_app" : false,
  "icon" : {
    "color" : "pink",
    "glyph" : "magic"
  },
  "name" : "Crypto Price",
  "script" : "\/\/ =====================\n\/\/ Crypto Widget Pro ‚Äî –µ–¥–∏–Ω—ã–π —Å—Ç–∏–ª—å –∫–æ–ª–æ–Ω–æ–∫\n\/\/ =====================\n\n\/\/ === –ö–æ–Ω—Ñ–∏–≥\nconst CONFIG = {\n  cacheMinutes: 15,\n  timeout: 10,\n  maxRetries: 3,\n\n  icons: { coin: 18, portfolio: 18 },\n\n  fonts: {\n    main: { symbol: 8, price: 8, change: 6 },\n    portfolio: { symbol: 8, value: 8, percent: 6 }\n  },\n\n  colors: {\n    text: new Color(\"#ffffff\"),\n    subtext: new Color(\"#aaaaaa\"),\n    portfolio: new Color(\"#aaaaaa\"),\n    up: new Color(\"#00ff88\"),\n    down: new Color(\"#ff5555\")\n  }\n};\n\n\/\/ === –°–ø—Ä–∞–≤–æ—á–Ω–∏–∫ –º–æ–Ω–µ—Ç (–¥–µ—Ñ–æ–ª—Ç–Ω—ã–π –Ω–∞–±–æ—Ä)\nlet coins = [\n  { id: \"bitcoin\",           symbol: \"BTC\",  icon: \"https:\/\/s2.coinmarketcap.com\/static\/img\/coins\/64x64\/1.png\" },\n  { id: \"the-open-network\",  symbol: \"TON\",  icon: \"https:\/\/assets.coingecko.com\/coins\/images\/17980\/large\/ton_symbol.png\" },\n  { id: \"near\",              symbol: \"NEAR\", icon: \"https:\/\/s2.coinmarketcap.com\/static\/img\/coins\/64x64\/6535.png\" },\n  { id: \"solana\",            symbol: \"SOL\",  icon: \"https:\/\/s2.coinmarketcap.com\/static\/img\/coins\/64x64\/5426.png\" },\n  { id: \"ethereum\",          symbol: \"ETH\",  icon: \"https:\/\/s2.coinmarketcap.com\/static\/img\/coins\/64x64\/1027.png\" },\n  { id: \"cardano\",           symbol: \"ADA\",  icon: \"https:\/\/s2.coinmarketcap.com\/static\/img\/coins\/64x64\/2010.png\" }\n];\n\n\/\/ –ë—ã—Å—Ç—Ä—ã–π –¥–æ—Å—Ç—É–ø coinId ‚Üí –æ–±—ä–µ–∫—Ç –º–æ–Ω–µ—Ç—ã\nconst COINS_BY_ID = new Map(coins.map(c => [c.id, c]));\n\n\/\/ === –§–°\/–ø—É—Ç–∏\nconst fm = FileManager.local();\nconst basePath = fm.documentsDirectory();\nconst paths = {\n  icons:     fm.joinPath(basePath, \"crypto_icons\"),\n  cache:     fm.joinPath(basePath, \"crypto_cache.json\"),     \/\/ –∫—ç—à —Ü–µ–Ω (—Å –∫–ª—é—á–æ–º ids)\n  search:    fm.joinPath(basePath, \"search_cache.json\"),     \/\/ –∫—ç—à –ø–æ–∏—Å–∫–∞\n  settings:  fm.joinPath(basePath, \"crypto_settings.json\"),\n  portfolio: fm.joinPath(basePath, \"crypto_portfolio.json\"),\n  alerts:    fm.joinPath(basePath, \"crypto_alerts.json\")\n};\nif (!fm.fileExists(paths.icons)) fm.createDirectory(paths.icons);\n\n\/\/ === –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é\nconst DEFAULT_SETTINGS = {\n  selectedCoins: coins.slice(0, 3),\n  extraCoins: coins.slice(3, 6),\n  rightMode: 'extra', \/\/ 'extra' | 'portfolio'\n  showChange: true,\n  notifications: { enabled: true, priceChange: 10, portfolioChange: 5 }\n};\n\n\/\/ =====================\n\/\/ –£—Ç–∏–ª–∏—Ç—ã\n\/\/ =====================\n\n\/\/ –ù–∞—Å—Ç—Ä–æ–π–∫–∏\nfunction loadSettings() {\n  if (fm.fileExists(paths.settings)) {\n    try {\n      const settings = JSON.parse(fm.readString(paths.settings));\n      return { ...DEFAULT_SETTINGS, ...settings };\n    } catch (e) {\n      console.log(`‚ö†Ô∏è –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫: ${e.message}`);\n    }\n  }\n  return { ...DEFAULT_SETTINGS };\n}\nfunction saveSettings(settings) {\n  try { fm.writeString(paths.settings, JSON.stringify(settings)); }\n  catch (e) { console.log(`‚ö†Ô∏è –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫: ${e.message}`); }\n}\n\n\/\/ –î–∏–∞–ª–æ–≥\nasync function showAlert(title, message) {\n  const alert = new Alert();\n  alert.title = title;\n  alert.message = message;\n  alert.addAction(\"OK\");\n  await alert.presentAlert();\n}\n\n\/\/ –ü–æ–≤—Ç–æ—Ä—ã —Å –±—ç–∫–æ—Ñ—Ñ–æ–º\nclass NetworkError extends Error {\n  constructor(message, retryable = true) { super(message); this.retryable = retryable; }\n}\nasync function retryAsync(fn, maxRetries = CONFIG.maxRetries) {\n  for (let i = 0; i < maxRetries; i++) {\n    try { return await fn(); }\n    catch (error) {\n      console.log(`‚Üª –ü–æ–ø—ã—Ç–∫–∞ ${i + 1}\/${maxRetries} –Ω–µ—É–¥–∞—á–Ω–∞: ${error.message}`);\n      if (i === maxRetries - 1 || !error.retryable) throw error;\n      await new Promise(resolve => Timer.schedule(1000 * (i + 1), false, resolve));\n    }\n  }\n}\n\n\/\/ –û–±—â–∏–π –∫—ç—à (–¥–ª—è –º–µ–ª–∫–∏—Ö —Å–ª–æ–≤–∞—Ä–µ–π)\nclass Cache {\n  static isExpired(timestamp, minutes) {\n    return (Date.now() - timestamp) \/ 60000 > minutes;\n  }\n  static read(path) {\n    if (!fm.fileExists(path)) return null;\n    try {\n      const raw = JSON.parse(fm.readString(path));\n      return this.isExpired(raw.timestamp, CONFIG.cacheMinutes) ? null : raw.data;\n    } catch (e) {\n      console.log(`‚ö†Ô∏è –û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è –∫—ç—à–∞: ${e.message}`);\n      return null;\n    }\n  }\n  static write(path, data) {\n    try { fm.writeString(path, JSON.stringify({ data, timestamp: Date.now() })); }\n    catch (e) { console.log(`‚ö†Ô∏è –û—à–∏–±–∫–∞ –∑–∞–ø–∏—Å–∏ –∫—ç—à–∞: ${e.message}`); }\n  }\n}\n\n\/\/ –õ–æ–∫–∞–ª—å–Ω—ã–π –∫—ç—à —Ü–µ–Ω —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –Ω–∞–±–æ—Ä–∞ ids (—á—Ç–æ–±—ã –∫—ç—à –ø–æ–¥—Ö–æ–¥–∏–ª –∫ –∑–∞–ø—Ä–æ—Å—É)\nfunction readPricesCache(expectedIdsCSV) {\n  if (!fm.fileExists(paths.cache)) return null;\n  try {\n    const raw = JSON.parse(fm.readString(paths.cache));\n    if (Cache.isExpired(raw.timestamp, CONFIG.cacheMinutes)) return null;\n    if (raw.ids !== expectedIdsCSV) return null;\n    return raw.data || null;\n  } catch (e) {\n    console.log(`‚ö†Ô∏è –û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è –∫—ç—à–∞ —Ü–µ–Ω: ${e.message}`);\n    return null;\n  }\n}\nfunction writePricesCache(idsCSV, data) {\n  try {\n    fm.writeString(paths.cache, JSON.stringify({ data, timestamp: Date.now(), ids: idsCSV }));\n  } catch (e) {\n    console.log(`‚ö†Ô∏è –û—à–∏–±–∫–∞ –∑–∞–ø–∏—Å–∏ –∫—ç—à–∞ —Ü–µ–Ω: ${e.message}`);\n  }\n}\n\n\/\/ =====================\n\/\/ API\n\/\/ =====================\n\n\/\/ –ò–∫–æ–Ω–∫–∞\nasync function getIcon(coin) {\n  const file = fm.joinPath(paths.icons, `${coin.symbol}.png`);\n  if (fm.fileExists(file)) {\n    try { const img = Image.fromFile(file); if (img) return img; } catch { fm.remove(file); }\n  }\n  return await retryAsync(async () => {\n    const req = new Request(coin.icon);\n    req.timeoutInterval = CONFIG.timeout;\n    const img = await req.loadImage();\n    if (!img) throw new NetworkError(\"–ò–∫–æ–Ω–∫–∞ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞\");\n    try { fm.writeImage(file, img); } catch (e) { console.log(`‚ö†Ô∏è –ù–µ —Å–æ—Ö—Ä–∞–Ω–∏–ª –∏–∫–æ–Ω–∫—É ${coin.symbol}: ${e.message}`); }\n    return img;\n  });\n}\n\n\/\/ –ü–æ–∏—Å–∫ –º–æ–Ω–µ—Ç—ã –ø–æ —Å–∏–º–≤–æ–ª—É\nasync function searchCoin(symbol) {\n  const cached = Cache.read(paths.search);\n  if (cached && cached[symbol]) return cached[symbol];\n\n  try {\n    const url = `https:\/\/api.coingecko.com\/api\/v3\/search?query=${encodeURIComponent(symbol)}`;\n    const req = new Request(url);\n    req.timeoutInterval = CONFIG.timeout;\n    const data = await req.loadJSON();\n\n    if (!data?.coins?.length) throw new NetworkError(\"–¢–æ–∫–µ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω\");\n\n    const results = data.coins.slice(0, 5).map(coin => ({\n      id: coin.id,\n      symbol: coin.symbol.toUpperCase(),\n      name: coin.name,\n      icon: coin.large || coin.thumb || coins[0].icon\n    }));\n\n    const newCache = { ...(cached || {}), [symbol]: results };   \/\/ ‚Üê –±–µ–∑–æ–ø–∞—Å–Ω–æ–µ —Å–ª–∏—è–Ω–∏–µ\n    Cache.write(paths.search, newCache);\n    return results;\n  } catch (e) {\n    console.log(`‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞ —Ç–æ–∫–µ–Ω–∞ ${symbol}: ${e.message}`);\n    return null;\n  }\n}\n\n\/\/ –¶–µ–Ω—ã –¥–ª—è –Ω–∞–±–æ—Ä–∞ –º–æ–Ω–µ—Ç (—Å –∫—ç—à–µ–º –ø–æ ids)\nasync function fetchPrices(coinList = coins) {\n  const ids = coinList.map(c => c.id).join(\",\");\n  const cached = readPricesCache(ids);\n  if (cached) return cached;\n\n  return await retryAsync(async () => {\n    const url = `https:\/\/api.coingecko.com\/api\/v3\/simple\/price?ids=${ids}&vs_currencies=usd&include_24hr_change=true`;\n    const req = new Request(url);\n    req.timeoutInterval = CONFIG.timeout;\n    const data = await req.loadJSON();\n    if (!data || Object.keys(data).length === 0) throw new NetworkError(\"–ü—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç –æ—Ç API\");\n    writePricesCache(ids, data);\n    return data;\n  });\n}\n\n\/\/ =====================\n\/\/ –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ\n\/\/ =====================\nfunction formatPrice(price) {\n  if (!price || price === 0) return \"‚Äî\";\n  if (price >= 1_000_000) return `${(price \/ 1_000_000).toFixed(1)}M$`;\n  if (price >= 1_000)     return `${(price \/ 1_000).toFixed(1)}K$`;\n  if (price >= 1)         return `${price.toFixed(2)}$`;\n  if (price >= 0.01)      return `${price.toFixed(4)}$`;\n  return `${price.toFixed(6).replace(\/0+$\/, \"\").replace(\/\\.$\/, \"\")}$`;\n}\nfunction formatCurrency(value) {\n  if (value >= 1_000_000) return `${(value \/ 1_000_000).toFixed(1)}M$`;\n  if (value >= 1_000)     return `${(value \/ 1_000).toFixed(1)}K$`;\n  return `${value.toFixed(2)}$`;\n}\n\n\/\/ =====================\n\/\/ –ü–æ—Ä—Ç—Ñ–æ–ª–∏–æ\n\/\/ =====================\nclass Portfolio {\n  static load() {\n    if (fm.fileExists(paths.portfolio)) {\n      try { return JSON.parse(fm.readString(paths.portfolio)); }\n      catch (e) { console.log(`‚ö†Ô∏è –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ—Ä—Ç—Ñ–æ–ª–∏–æ: ${e.message}`); }\n    }\n    return {};\n  }\n  static save(portfolio) {\n    try { fm.writeString(paths.portfolio, JSON.stringify(portfolio)); }\n    catch (e) { console.log(`‚ö†Ô∏è –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–æ—Ä—Ç—Ñ–æ–ª–∏–æ: ${e.message}`); }\n  }\n  static add(coinId, amount) {\n    const p = this.load();\n    p[coinId] = (p[coinId] || 0) + parseFloat(amount);\n    this.save(p);\n  }\n  static remove(coinId) {\n    const p = this.load();\n    delete p[coinId];\n    this.save(p);\n  }\n  static getValue(prices) {\n    const portfolio = this.load();\n    let totalValue = 0;\n    const breakdown = [];\n\n    for (const [coinId, amount] of Object.entries(portfolio)) {\n      const info = prices[coinId];\n      if (!info) continue;\n      const price = info.usd || 0;\n      const change = info.usd_24h_change || 0;\n      const value = amount * price;\n      totalValue += value;\n\n      const coin = COINS_BY_ID.get(coinId) || coins.find(c => c.id === coinId);\n      if (coin && value > 0) {\n        breakdown.push({\n          symbol: coin.symbol,\n          amount,\n          value,\n          change,\n          percentage: 0,\n          coin\n        });\n      }\n    }\n\n    breakdown.forEach(item => {\n      item.percentage = totalValue > 0 ? (item.value \/ totalValue) * 100 : 0;\n    });\n\n    return { totalValue, breakdown };\n  }\n}\n\n\/\/ =====================\n\/\/ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è\n\/\/ =====================\nclass NotificationManager {\n  static load() {\n    if (fm.fileExists(paths.alerts)) {\n      try { return JSON.parse(fm.readString(paths.alerts)); } catch {}\n    }\n    return { lastPrices: {}, lastPortfolioValue: 0, lastCheck: 0 };\n  }\n  static save(data) { fm.writeString(paths.alerts, JSON.stringify(data)); }\n\n  static async checkAndNotify(prices, settings) {\n    if (!settings.notifications.enabled) return;\n\n    const state = this.load();\n    const now = Date.now();\n    if (now - state.lastCheck < 3600000) return; \/\/ –Ω–µ —á–∞—â–µ —á–∞—Å–∞\n\n    const notifications = [];\n    const allCoins = [...(settings.selectedCoins || []), ...(settings.extraCoins || [])];\n\n    \/\/ –ò–∑–º–µ–Ω–µ–Ω–∏—è —Ü–µ–Ω\n    for (const coin of allCoins) {\n      const current = prices[coin.id]?.usd;\n      const prev = state.lastPrices[coin.id];\n      if (current && prev) {\n        const change = ((current - prev) \/ prev) * 100;\n        if (Math.abs(change) >= settings.notifications.priceChange) {\n          notifications.push({\n            title: `${coin.symbol} ${change > 0 ? 'üìà' : 'üìâ'}`,\n            body: `–ò–∑–º–µ–Ω–µ–Ω–∏–µ –Ω–∞ ${change.toFixed(1)}%: ${formatCurrency(current)}`\n          });\n        }\n      }\n      if (current) state.lastPrices[coin.id] = current;\n    }\n\n    \/\/ –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –ø–æ—Ä—Ç—Ñ–µ–ª—è (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –≤—ã–±—Ä–∞–Ω —Ä–µ–∂–∏–º –ø–æ—Ä—Ç—Ñ–µ–ª—è —Å–ø—Ä–∞–≤–∞)\n    if (settings.rightMode === 'portfolio') {\n      const { totalValue } = Portfolio.getValue(prices);\n      if (state.lastPortfolioValue > 0 && totalValue > 0) {\n        const change = ((totalValue - state.lastPortfolioValue) \/ state.lastPortfolioValue) * 100;\n        if (Math.abs(change) >= settings.notifications.portfolioChange) {\n          notifications.push({\n            title: `–ü–æ—Ä—Ç—Ñ–æ–ª–∏–æ ${change > 0 ? 'üí∞' : 'üìâ'}`,\n            body: `–ò–∑–º–µ–Ω–µ–Ω–∏–µ –Ω–∞ ${change.toFixed(1)}%: ${formatCurrency(totalValue)}`\n          });\n        }\n      }\n      state.lastPortfolioValue = totalValue;\n    }\n\n    \/\/ –û—Ç–ø—Ä–∞–≤–∫–∞\n    notifications.forEach(n => {\n      const notif = new Notification();\n      notif.title = n.title;\n      notif.body = n.body;\n      notif.schedule();\n    });\n\n    state.lastCheck = now;\n    this.save(state);\n  }\n}\n\n\/\/ =====================\n\/\/ –†–µ–Ω–¥–µ—Ä —Å—Ç—Ä–æ–∫–∏ (—É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è)\n\/\/ =====================\nasync function renderItem(stack, data, settings) {\n  const itemStack = stack.addStack();\n  itemStack.layoutHorizontally();\n  itemStack.spacing = 3;\n\n  \/\/ –ò–∫–æ–Ω–∫–∞\/–ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä\n  if (data.type === 'portfolio-header') {\n    const box = itemStack.addStack();\n    box.size = new Size(CONFIG.icons.coin, CONFIG.icons.coin);\n    box.cornerRadius = 2;\n    box.centerAlignContent();\n    const t = box.addText(\"üíº\");\n    t.font = Font.systemFont(14);\n    t.centerAlignText();\n  } else if (data.type === 'empty-portfolio') {\n    const box = itemStack.addStack();\n    box.size = new Size(CONFIG.icons.coin, CONFIG.icons.coin);\n    box.cornerRadius = 2;\n    box.centerAlignContent();\n    const t = box.addText(\"üìä\");\n    t.font = Font.systemFont(14);\n    t.centerAlignText();\n  } else {\n    try {\n      const coinIcon = await getIcon(data.coin);\n      const img = itemStack.addImage(coinIcon);\n      img.imageSize = new Size(CONFIG.icons.coin, CONFIG.icons.coin);\n      img.cornerRadius = 2;\n    } catch {\n      const fb = itemStack.addText(\"üí∞\");\n      fb.font = Font.systemFont(CONFIG.icons.coin - 2);\n    }\n  }\n\n  \/\/ –¢–µ–∫—Å—Ç–æ–≤–æ–π –±–ª–æ–∫\n  const textStack = itemStack.addStack();\n  textStack.layoutVertically();\n  textStack.spacing = 0;\n\n  \/\/ –í–µ—Ä—Ö–Ω—è—è —Å—Ç—Ä–æ–∫–∞ (—Ç–∏–∫–µ—Ä\/–∑–∞–≥–æ–ª–æ–≤–æ–∫)\n  const titleText = textStack.addText(data.title);\n  titleText.font = Font.systemFont(CONFIG.fonts.main.symbol);\n  titleText.textColor = CONFIG.colors.text;\n\n  \/\/ –ù–∏–∂–Ω—è—è —Å—Ç—Ä–æ–∫–∞ (–∑–Ω–∞—á–µ–Ω–∏–µ + –∏–∑–º–µ–Ω–µ–Ω–∏–µ)\n  const bottom = textStack.addStack();\n  bottom.layoutHorizontally();\n  bottom.spacing = 2;\n\n  const valueText = bottom.addText(data.value);\n  valueText.font = Font.systemFont(CONFIG.fonts.main.price);\n  valueText.textColor = data.valueColor || CONFIG.colors.subtext;\n\n  if (data.change && settings.showChange) {\n    const changeText = bottom.addText(data.change);\n    changeText.font = Font.systemFont(CONFIG.fonts.main.change);\n    changeText.textColor = data.changeColor || CONFIG.colors.subtext;\n  }\n}\n\n\/\/ =====================\n\/\/ –í–∏–¥–∂–µ—Ç\n\/\/ =====================\nasync function createWidget() {\n  const settings = loadSettings();\n  const selectedCoins = settings.selectedCoins || coins.slice(0, 3);\n  const extraCoins    = settings.extraCoins    || coins.slice(3, 6);\n\n  const widget = new ListWidget();\n  widget.setPadding(0, 2, 0, 2);\n  widget.url = URLScheme.forRunningScript();\n\n  try {\n    \/\/ –°–±–æ—Ä –≤—Å–µ—Ö –Ω—É–∂–Ω—ã—Ö –º–æ–Ω–µ—Ç (–±–µ–∑ –¥—É–±–ª–µ–π)\n    const portfolio = Portfolio.load();\n    const portfolioCoins = Object.keys(portfolio).map(id => COINS_BY_ID.get(id) || coins.find(c => c.id === id)).filter(Boolean);\n    const allCoins = [...selectedCoins, ...extraCoins, ...portfolioCoins];\n    const uniqueCoins = allCoins.filter((c, i, arr) => arr.findIndex(x => x.id === c.id) === i);\n\n    \/\/ –¶–µ–Ω—ã –∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è\n    const prices = await fetchPrices(uniqueCoins.length ? uniqueCoins : coins);\n    await NotificationManager.checkAndNotify(prices, settings);\n\n    \/\/ –û—Å–Ω–æ–≤–Ω–æ–π —Ä—è–¥ (–ª–µ–≤–∞—è + –ø—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞)\n    const mainStack = widget.addStack();\n    mainStack.layoutHorizontally();\n\n    \/\/ –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ ‚Äî –æ—Å–Ω–æ–≤–Ω—ã–µ –º–æ–Ω–µ—Ç—ã\n    const leftStack = mainStack.addStack();\n    leftStack.layoutVertically();\n    leftStack.spacing = 1;\n\n    for (const coin of selectedCoins) {\n      const info = prices[coin.id];\n      if (!info) continue;\n      const price = info.usd ?? 0;\n      const change = info.usd_24h_change ?? 0;\n      const isPositive = change >= 0;\n      await renderItem(leftStack, {\n        type: 'coin',\n        coin,\n        title: coin.symbol,\n        value: formatPrice(price),\n        change: `${isPositive ? \"‚ñ≤\" : \"‚ñº\"}${Math.abs(change).toFixed(0)}%`,\n        changeColor: isPositive ? CONFIG.colors.up : CONFIG.colors.down\n      }, settings);\n    }\n\n    \/\/ –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ –∫–æ–ª–æ–Ω–æ–∫\n    mainStack.addSpacer();\n\n    \/\/ –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ ‚Äî –¥–æ–ø. –º–æ–Ω–µ—Ç—ã –∏–ª–∏ –ø–æ—Ä—Ç—Ñ–µ–ª—å\n    const rightStack = mainStack.addStack();\n    rightStack.layoutVertically();\n    rightStack.spacing = 1;\n\n    if (settings.rightMode === 'portfolio') {\n      \/\/ –ü–æ—Ä—Ç—Ñ–µ–ª—å\n      const { totalValue, breakdown } = Portfolio.getValue(prices);\n\n      if (breakdown.length > 0) {\n        \/\/ –ó–∞–≥–æ–ª–æ–≤–æ–∫ –ø–æ—Ä—Ç—Ñ–µ–ª—è\n        await renderItem(rightStack, {\n          type: 'portfolio-header',\n          title: '–ü–æ—Ä—Ç—Ñ–µ–ª—å',\n          value: formatCurrency(totalValue),\n          valueColor: CONFIG.colors.portfolio\n        }, settings);\n\n        \/\/ –¢–æ–ø-–ø–æ–∑–∏—Ü–∏–∏\n        const maxPositions = (selectedCoins.length >= 3) ? 2 : 3;\n        const topPositions = breakdown.sort((a, b) => b.value - a.value).slice(0, maxPositions);\n\n        for (const position of topPositions) {\n          const isPositive = position.change >= 0;\n          await renderItem(rightStack, {\n            type: 'portfolio-coin',\n            coin: position.coin,\n            title: position.symbol,\n            value: formatCurrency(position.value),\n            valueColor: CONFIG.colors.portfolio,\n            change: settings.showChange\n              ? `${isPositive ? \"‚ñ≤\" : \"‚ñº\"}${Math.abs(position.change).toFixed(0)}%`\n              : `${position.percentage.toFixed(0)}%`,\n            changeColor: settings.showChange\n              ? (isPositive ? CONFIG.colors.up : CONFIG.colors.down)\n              : CONFIG.colors.subtext\n          }, settings);\n        }\n      } else {\n        \/\/ –ü—É—Å—Ç–æ–π –ø–æ—Ä—Ç—Ñ–µ–ª—å\n        await renderItem(rightStack, {\n          type: 'empty-portfolio',\n          title: '–ü–æ—Ä—Ç—Ñ–µ–ª—å',\n          value: '–ü—É—Å—Ç–æ',\n          valueColor: CONFIG.colors.subtext\n        }, settings);\n      }\n    } else {\n      \/\/ –î–æ–ø. –º–æ–Ω–µ—Ç—ã\n      for (const coin of extraCoins) {\n        const info = prices[coin.id];\n        if (!info) continue;\n        const price = info.usd ?? 0;\n        const change = info.usd_24h_change ?? 0;\n        const isPositive = change >= 0;\n        await renderItem(rightStack, {\n          type: 'coin',\n          coin,\n          title: coin.symbol,\n          value: formatPrice(price),\n          change: `${isPositive ? \"‚ñ≤\" : \"‚ñº\"}${Math.abs(change).toFixed(0)}%`,\n          changeColor: isPositive ? CONFIG.colors.up : CONFIG.colors.down\n        }, settings);\n      }\n    }\n\n  } catch (error) {\n    \/\/ –ê–≤–∞—Ä–∏–π–Ω—ã–π —ç–∫—Ä–∞–Ω\n    const errorStack = widget.addStack();\n    errorStack.layoutVertically();\n    errorStack.centerAlignContent();\n\n    const errorIcon = errorStack.addText(\"‚ö†Ô∏è\");\n    errorIcon.font = Font.systemFont(CONFIG.icons.coin);\n\n    const errorText = errorStack.addText(\"–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏\");\n    errorText.textColor = CONFIG.colors.subtext;\n    errorText.font = Font.systemFont(CONFIG.fonts.main.symbol);\n    errorText.centerAlignText();\n\n    console.log(`‚ùå –û—à–∏–±–∫–∞ –≤–∏–¥–∂–µ—Ç–∞: ${error.message}`);\n  }\n\n  return widget;\n}\n\n\/\/ =====================\n\/\/ –ü–æ—Ä—Ç—Ñ–æ–ª–∏–æ ‚Äî UI\n\/\/ =====================\nasync function addPortfolioPosition(coin) {\n  const a = new Alert();\n  a.title = `–î–æ–±–∞–≤–∏—Ç—å ${coin.symbol}`;\n  a.message = \"–í–≤–µ–¥–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–æ–Ω–µ—Ç\";\n  a.addTextField(\"0.0\", \"–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ\");\n  a.addAction(\"–î–æ–±–∞–≤–∏—Ç—å\");\n  a.addCancelAction(\"–û—Ç–º–µ–Ω–∞\");\n\n  if (await a.presentAlert() === 0) {\n    const amount = parseFloat(a.textFieldValue(0));\n    if (amount > 0) {\n      Portfolio.add(coin.id, amount);\n      await showAlert(\"–£—Å–ø–µ—Ö\", `–î–æ–±–∞–≤–ª–µ–Ω–æ ${amount} ${coin.symbol}`);\n    }\n  }\n}\nasync function addPortfolioBySymbol() {\n  const a = new Alert();\n  a.title = \"–ù–∞–π—Ç–∏ —Ç–æ–∫–µ–Ω\";\n  a.message = \"–í–≤–µ–¥–∏—Ç–µ —Å–∏–º–≤–æ–ª —Ç–æ–∫–µ–Ω–∞\";\n  a.addTextField(\"\", \"–°–∏–º–≤–æ–ª\");\n  a.addAction(\"–ù–∞–π—Ç–∏\");\n  a.addCancelAction(\"–û—Ç–º–µ–Ω–∞\");\n\n  if (await a.presentAlert() === 0) {\n    const symbol = a.textFieldValue(0).trim().toUpperCase();\n    if (!symbol) return;\n\n    const results = await searchCoin(symbol);\n    if (!results) { await showAlert(\"–û—à–∏–±–∫–∞\", `–¢–æ–∫–µ–Ω ${symbol} –Ω–µ –Ω–∞–π–¥–µ–Ω`); return; }\n\n    let selected = results[0];\n    if (results.length > 1) {\n      const menu = new Alert();\n      menu.title = \"–í—ã–±–µ—Ä–∏—Ç–µ —Ç–æ–∫–µ–Ω\";\n      results.forEach(c => menu.addAction(`${c.symbol} - ${c.name}`));\n      menu.addCancelAction(\"–û—Ç–º–µ–Ω–∞\");\n      const choice = await menu.presentSheet();\n      if (choice >= 0 && choice < results.length) selected = results[choice]; else return;\n    }\n\n    if (!coins.some(c => c.id === selected.id)) {\n      coins.push(selected);\n      COINS_BY_ID.set(selected.id, selected);\n    }\n    await addPortfolioPosition(selected);\n  }\n}\nasync function showPortfolioMenu() {\n  const portfolio = Portfolio.load();\n  const menu = new Alert();\n  menu.title = \"üíº –ü–æ—Ä—Ç—Ñ–æ–ª–∏–æ\";\n\n  menu.addAction(\"–î–æ–±–∞–≤–∏—Ç—å –ø–æ–∑–∏—Ü–∏—é\");\n  menu.addAction(\"–ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ –ø–æ–∑–∏—Ü–∏–∏\");\n  if (Object.keys(portfolio).length > 0) {\n    menu.addAction(\"–£–¥–∞–ª–∏—Ç—å –ø–æ–∑–∏—Ü–∏—é\");\n    menu.addDestructiveAction(\"–û—á–∏—Å—Ç–∏—Ç—å –ø–æ—Ä—Ç—Ñ–æ–ª–∏–æ\");\n  }\n  menu.addCancelAction(\"–ù–∞–∑–∞–¥\");\n\n  const choice = await menu.presentSheet();\n\n  switch (choice) {\n    case 0: {\n      const addMenu = new Alert();\n      addMenu.title = \"–î–æ–±–∞–≤–∏—Ç—å –≤ –ø–æ—Ä—Ç—Ñ–æ–ª–∏–æ\";\n      coins.forEach(c => addMenu.addAction(`${c.symbol} - ${c.id.replace(\/-\/g, ' ')}`));\n      addMenu.addAction(\"–ù–∞–π—Ç–∏ —Ç–æ–∫–µ–Ω –ø–æ —Å–∏–º–≤–æ–ª—É\");\n      addMenu.addCancelAction(\"–û—Ç–º–µ–Ω–∞\");\n\n      const addChoice = await addMenu.presentSheet();\n      if (addChoice >= 0 && addChoice < coins.length) {\n        await addPortfolioPosition(coins[addChoice]);\n      } else if (addChoice === coins.length) {\n        await addPortfolioBySymbol();\n      }\n      break;\n    }\n    case 1: {\n      const prices = await fetchPrices(coins);\n      const { totalValue, breakdown } = Portfolio.getValue(prices);\n      const a = new Alert();\n      a.title = \"üíº –ü–æ—Ä—Ç—Ñ–æ–ª–∏–æ\";\n\n      if (!breakdown.length) {\n        a.message = \"–ü–æ—Ä—Ç—Ñ–æ–ª–∏–æ –ø—É—Å—Ç–æ\";\n      } else {\n        let msg = `üí∞ –û–±—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å: ${formatCurrency(totalValue)}\\n\\n`;\n        breakdown.sort((a, b) => b.value - a.value).forEach(pos => {\n          const icon = pos.change >= 0 ? \"üìà\" : \"üìâ\";\n          msg += `${pos.symbol}: ${pos.amount.toFixed(4)}\\n`;\n          msg += `‚îî ${formatCurrency(pos.value)} (${pos.percentage.toFixed(1)}%) ${icon}${Math.abs(pos.change).toFixed(1)}%\\n\\n`;\n        });\n        a.message = msg;\n      }\n      a.addAction(\"OK\");\n      await a.presentAlert();\n      break;\n    }\n    case 2: {\n      const positions = Object.keys(portfolio);\n      if (!positions.length) { await showAlert(\"–ü–æ—Ä—Ç—Ñ–æ–ª–∏–æ –ø—É—Å—Ç–æ\", \"–ù–µ—Ç –ø–æ–∑–∏—Ü–∏–π –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è\"); return; }\n\n      const rm = new Alert();\n      rm.title = \"–£–¥–∞–ª–∏—Ç—å –ø–æ–∑–∏—Ü–∏—é\";\n      positions.forEach(coinId => {\n        const coin = COINS_BY_ID.get(coinId) || coins.find(c => c.id === coinId);\n        const amount = portfolio[coinId];\n        rm.addAction(`${coin?.symbol || coinId} - ${amount.toFixed(4)}`);\n      });\n      rm.addCancelAction(\"–û—Ç–º–µ–Ω–∞\");\n\n      const idx = await rm.presentSheet();\n      if (idx >= 0 && idx < positions.length) {\n        Portfolio.remove(positions[idx]);\n        await showAlert(\"–£—Å–ø–µ—Ö\", \"–ü–æ–∑–∏—Ü–∏—è —É–¥–∞–ª–µ–Ω–∞\");\n      }\n      break;\n    }\n    case 3: {\n      const confirm = new Alert();\n      confirm.title = \"‚ö†Ô∏è –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ\";\n      confirm.message = \"–£–¥–∞–ª–∏—Ç—å –≤—Å–µ –ø–æ–∑–∏—Ü–∏–∏ –∏–∑ –ø–æ—Ä—Ç—Ñ–æ–ª–∏–æ?\";\n      confirm.addDestructiveAction(\"–£–¥–∞–ª–∏—Ç—å\");\n      confirm.addCancelAction(\"–û—Ç–º–µ–Ω–∞\");\n      if (await confirm.presentAlert() === 0) {\n        fm.remove(paths.portfolio);\n        await showAlert(\"–£—Å–ø–µ—Ö\", \"–ü–æ—Ä—Ç—Ñ–æ–ª–∏–æ –æ—á–∏—â–µ–Ω–æ\");\n      }\n      break;\n    }\n  }\n}\n\n\/\/ =====================\n\/\/ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ ‚Äî UI\n\/\/ =====================\nasync function showThresholdInput(key, title, settings) {\n  const a = new Alert();\n  a.title = title;\n  a.addTextField(settings.notifications[key].toString(), \"–ü—Ä–æ—Ü–µ–Ω—Ç\");\n  a.addAction(\"–°–æ—Ö—Ä–∞–Ω–∏—Ç—å\");\n  a.addCancelAction(\"–û—Ç–º–µ–Ω–∞\");\n\n  if (await a.presentAlert() === 0) {\n    const value = parseFloat(a.textFieldValue(0));\n    if (value > 0 && value <= 100) {\n      settings.notifications[key] = value;\n      saveSettings(settings);\n    }\n  }\n}\nasync function showCoinSelection(key, title) {\n  const settings = loadSettings();\n  const menu = new Alert();\n  menu.title = title;\n\n  coins.forEach(coin => {\n    const isSelected = (settings[key] || []).some(c => c.id === coin.id);\n    menu.addAction(`${isSelected ? \"‚úì\" : \"‚óã\"} ${coin.symbol}`);\n  });\n  menu.addCancelAction(\"–ì–æ—Ç–æ–≤–æ\");\n\n  const choice = await menu.presentSheet();\n  if (choice >= 0 && choice < coins.length) {\n    const selectedCoin = coins[choice];\n    const current = settings[key] || [];\n\n    const i = current.findIndex(c => c.id === selectedCoin.id);\n    if (i >= 0) current.splice(i, 1);\n    else if (current.length < 3) current.push(selectedCoin);\n\n    settings[key] = current;\n    saveSettings(settings);\n    await showCoinSelection(key, title);\n  }\n}\nfunction clearCache() {\n  let count = 0;\n\n  if (fm.fileExists(paths.icons)) {\n    const files = fm.listContents(paths.icons);\n    files.forEach(file => {\n      try { fm.remove(fm.joinPath(paths.icons, file)); count++; } catch {}\n    });\n  }\n  [paths.cache, paths.search].forEach(p => {\n    if (fm.fileExists(p)) {\n      try { fm.remove(p); count++; } catch {}\n    }\n  });\n\n  console.log(`üóë –û—á–∏—â–µ–Ω–æ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –∫—ç—à–∞: ${count}`);\n  return count;\n}\nasync function showNotificationSettings() {\n  const settings = loadSettings();\n  const menu = new Alert();\n  menu.title = \"üîî –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è\";\n\n  menu.addAction(settings.notifications.enabled ? \"–û—Ç–∫–ª—é—á–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è\" : \"–í–∫–ª—é—á–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è\");\n  if (settings.notifications.enabled) {\n    menu.addAction(`–ü–æ—Ä–æ–≥ —Ü–µ–Ω—ã: ${settings.notifications.priceChange}%`);\n    menu.addAction(`–ü–æ—Ä–æ–≥ –ø–æ—Ä—Ç—Ñ–æ–ª–∏–æ: ${settings.notifications.portfolioChange}%`);\n  }\n  menu.addCancelAction(\"–ù–∞–∑–∞–¥\");\n\n  const choice = await menu.presentSheet();\n  switch (choice) {\n    case 0:\n      settings.notifications.enabled = !settings.notifications.enabled;\n      saveSettings(settings);\n      break;\n    case 1:\n      await showThresholdInput('priceChange', '–ü–æ—Ä–æ–≥ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ü–µ–Ω—ã (%)', settings);\n      break;\n    case 2:\n      await showThresholdInput('portfolioChange', '–ü–æ—Ä–æ–≥ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–æ—Ä—Ç—Ñ–æ–ª–∏–æ (%)', settings);\n      break;\n  }\n}\nasync function showSettingsMenu() {\n  const settings = loadSettings();\n  const menu = new Alert();\n  menu.title = \"‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏\";\n\n  menu.addAction(\"–í—ã–±—Ä–∞—Ç—å –æ—Å–Ω–æ–≤–Ω—ã–µ –º–æ–Ω–µ—Ç—ã (–ª–µ–≤–æ)\");\n  menu.addAction(\"–í—ã–±—Ä–∞—Ç—å –¥–æ–ø –º–æ–Ω–µ—Ç—ã (–ø—Ä–∞–≤–æ)\");\n  menu.addAction(`–ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞: ${settings.rightMode === 'portfolio' ? '–ü–æ—Ä—Ç—Ñ–æ–ª–∏–æ' : '–î–æ–ø –º–æ–Ω–µ—Ç—ã'}`);\n  menu.addAction(\"–î–æ–±–∞–≤–∏—Ç—å —Ç–æ–∫–µ–Ω –ø–æ —Å–∏–º–≤–æ–ª—É\");\n  menu.addAction(settings.showChange ? \"–°–∫—Ä—ã—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è\" : \"–ü–æ–∫–∞–∑–∞—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è\");\n  menu.addAction(\"üîî –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è\");\n  menu.addAction(\"–°–±—Ä–æ—Å–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏\");\n  menu.addCancelAction(\"–ù–∞–∑–∞–¥\");\n\n  const choice = await menu.presentSheet();\n  switch (choice) {\n    case 0: await showCoinSelection('selectedCoins', '–í—ã–±–µ—Ä–∏—Ç–µ –æ—Å–Ω–æ–≤–Ω—ã–µ –º–æ–Ω–µ—Ç—ã (–º–∞–∫—Å. 3)'); break;\n    case 1: await showCoinSelection('extraCoins', '–í—ã–±–µ—Ä–∏—Ç–µ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –º–æ–Ω–µ—Ç—ã (–º–∞–∫—Å. 3)'); break;\n    case 2:\n      settings.rightMode = settings.rightMode === 'portfolio' ? 'extra' : 'portfolio';\n      saveSettings(settings);\n      break;\n    case 3: await addPortfolioBySymbol(); break;\n    case 4:\n      settings.showChange = !settings.showChange;\n      saveSettings(settings);\n      break;\n    case 5: await showNotificationSettings(); break;\n    case 6:\n      if (fm.fileExists(paths.settings)) {\n        fm.remove(paths.settings);\n        await showAlert(\"–£—Å–ø–µ—Ö\", \"–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–±—Ä–æ—à–µ–Ω—ã\");\n      }\n      break;\n  }\n}\n\n\/\/ =====================\n\/\/ –ì–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω ‚Äî UI\n\/\/ =====================\nasync function showMainMenu() {\n  const settings = loadSettings();\n  const rightModeText = settings.rightMode === 'portfolio' ? '–ü–æ—Ä—Ç—Ñ–æ–ª–∏–æ' : '–î–æ–ø –º–æ–Ω–µ—Ç—ã';\n\n  const menu = new Alert();\n  menu.title = \"‚ö° Crypto Widget Pro\";\n  menu.message = `–û—Å–Ω–æ–≤–Ω—ã–µ | ${rightModeText} | ${new Date().toLocaleTimeString()}`;\n\n  menu.addAction(\"üîÑ –û–±–Ω–æ–≤–∏—Ç—å\");\n  menu.addAction(\"üìä –ü–æ–∫–∞–∑–∞—Ç—å –≤–∏–¥–∂–µ—Ç\");\n  menu.addAction(\"üíº –ü–æ—Ä—Ç—Ñ–æ–ª–∏–æ\");\n  menu.addAction(\"‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏\");\n  menu.addDestructiveAction(\"üóë –û—á–∏—Å—Ç–∏—Ç—å –∫—ç—à\");\n  menu.addCancelAction(\"–ó–∞–∫—Ä—ã—Ç—å\");\n\n  const choice = await menu.presentSheet();\n\n  switch (choice) {\n    case 0: {\n      clearCache();\n      const widget = await createWidget();\n      await widget.presentSmall();\n      break;\n    }\n    case 1: {\n      const widget = await createWidget();\n      await widget.presentSmall();\n      break;\n    }\n    case 2: await showPortfolioMenu(); break;\n    case 3: await showSettingsMenu(); break;\n    case 4: {\n      const deleted = clearCache();\n      await showAlert(\"–û—á–∏—Å—Ç–∫–∞ –∫—ç—à–∞\", deleted > 0 ? `‚úÖ –£–¥–∞–ª–µ–Ω–æ —ç–ª–µ–º–µ–Ω—Ç–æ–≤: ${deleted}` : \"‚ÑπÔ∏è –ö—ç—à —É–∂–µ –ø—É—Å—Ç\");\n      break;\n    }\n  }\n}\n\n\/\/ =====================\n\/\/ –ó–∞–ø—É—Å–∫\n\/\/ =====================\nasync function main() {\n  if (config.runsInApp) {\n    await showMainMenu();\n  } else {\n    const widget = await createWidget();\n    Script.setWidget(widget);\n  }\n  Script.complete();\n}\nawait main();",
  "share_sheet_inputs" : [

  ]
}