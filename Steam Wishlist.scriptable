{
  "always_run_in_app" : false,
  "icon" : {
    "color" : "purple",
    "glyph" : "magic"
  },
  "name" : "Steam Wishlist",
  "script" : "\/*\n * Steam Wishlist Pro\n * Виджет для отображения игр из Steam вишлиста с ценами и скидками\n * Поддерживает все типы виджетов: домашние (small\/medium\/large) и локскрин (rectangular\/inline)\n *\/\n\n\/\/ ======================= КОНФИГУРАЦИЯ =======================\nconst CONFIG = {\n  STEAM_API_KEY: \"YOUR_API\",\n  STEAM_ID: args.widgetParameter || \"YOUR_STEAM_ID\", \/\/ Если нет параметра виджета, используем дефолтный ID\n  CACHE_FOLDER: \"steam_cache\",\n  CACHE_TTL: 12 * 60 * 60 * 1000, \/\/ 12 часов в миллисекундах\n\n  \/\/ Шрифты и цвета\n  FONT_FAMILY: Font.mediumSystemFont,\n  FONT_SIZES: {\n    TITLE_SMALL: 10,      \/\/ Заголовки для lock rect\n    TITLE_MEDIUM: 12,     \/\/ Заголовки для домашних виджетов\n    TITLE_INLINE: 12,     \/\/ Заголовки для inline виджета\n    PRICE: 10             \/\/ Шрифт цены\n  },\n  COLORS: {\n    TITLE: Color.white(),\n    DISCOUNT: Color.green(),\n    NO_DISCOUNT: Color.lightGray(),\n    ERROR: Color.red()\n  },\n\n  \/\/ Размеры постеров и скругления\n  POSTER: {\n    WIDTH: 100,\n    HEIGHT: 40,\n    CORNER_RADIUS: 6\n  },\n\n  \/\/ Отступы\n  PADDING: {\n    TOP: 12, BOTTOM: 12,\n    LEFT: 6, RIGHT: 6,\n    BETWEEN_ROWS: 4,\n    BETWEEN_ELEMENTS: 4,\n    ROW_INTERNAL: 4\n  },\n\n  \/\/ Ограничение длины текста\n  TRIM_LENGTHS: {\n    LOCK_RECT: 16,\n    INLINE: 16,\n    HOME: 25\n  },\n\n  \/\/ Настройки отображения в виджетах\n  WIDGET_CONFIG: {\n    small: { max: 4, posters: false },\n    medium: { max: 3, posters: true },\n    large: { max: 8, posters: true }\n  }\n};\n\n\/\/ ======================= УТИЛИТЫ =======================\n\n\/\/ Обрезка текста с добавлением \"…\"\nconst trimText = (text, maxLength) =>\n  text.length > maxLength ? text.substring(0, maxLength - 1) + \"…\" : text;\n\n\/\/ Форматирование цены (замена \"руб.\" на ₽)\nconst formatPrice = (price) => price.replace(\/руб\\.\/g, '₽');\n\n\/\/ ======================= API И КЭШИРОВАНИЕ =======================\n\n\/\/ Получение списка игр из Steam Wishlist\nasync function fetchWishlist() {\n  const url = `https:\/\/api.steampowered.com\/IWishlistService\/GetWishlist\/v1\/?key=${CONFIG.STEAM_API_KEY}&steamid=${CONFIG.STEAM_ID}`;\n  const req = new Request(url);\n  req.timeoutInterval = 10;\n  const res = await req.loadJSON();\n  if (!res?.response?.items) throw new Error(\"Не удалось получить вишлист\");\n  return res.response.items;\n}\n\n\/\/ Получение деталей конкретной игры с кэшированием\nasync function fetchGameDetails(appid) {\n  const fm = FileManager.local();\n  const cacheDir = fm.joinPath(fm.documentsDirectory(), CONFIG.CACHE_FOLDER);\n  if (!fm.fileExists(cacheDir)) fm.createDirectory(cacheDir);\n  const cacheFile = fm.joinPath(cacheDir, `${appid}.json`);\n\n  \/\/ Проверка кэша\n  if (fm.fileExists(cacheFile)) {\n    const modified = fm.modificationDate(cacheFile);\n    if ((Date.now() - modified.getTime()) < CONFIG.CACHE_TTL) {\n      try { return JSON.parse(fm.readString(cacheFile)); } catch {}\n    }\n  }\n\n  \/\/ Запрос к API Steam Store\n  const url = `https:\/\/store.steampowered.com\/api\/appdetails?appids=${appid}&filters=basic,price_overview`;\n  const req = new Request(url);\n  req.headers = { \"User-Agent\": \"Mozilla\/5.0 (iPhone; CPU iPhone OS 17_0 like Mac OS X)\" };\n  req.timeoutInterval = 10;\n\n  try {\n    const json = await req.loadJSON();\n    const data = json[appid]?.data;\n    if (!data) return null;\n\n    const game = {\n      id: appid,\n      name: data.name || `App ${appid}`,\n      discount: data.price_overview?.discount_percent || 0,\n      final_price: data.price_overview?.final_formatted || \"N\/A\",\n      cover: `https:\/\/cdn.cloudflare.steamstatic.com\/steam\/apps\/${appid}\/header.jpg`\n    };\n\n    \/\/ Сохраняем в кэш\n    fm.writeString(cacheFile, JSON.stringify(game));\n    return game;\n  } catch {\n    return null;\n  }\n}\n\n\/\/ Загрузка изображения с кэшированием\nasync function loadCachedImage(url, filename) {\n  const fm = FileManager.local();\n  const dir = fm.joinPath(fm.documentsDirectory(), CONFIG.CACHE_FOLDER);\n  if (!fm.fileExists(dir)) fm.createDirectory(dir);\n  const filePath = fm.joinPath(dir, filename);\n\n  if (fm.fileExists(filePath)) {\n    const modified = fm.modificationDate(filePath);\n    if ((Date.now() - modified.getTime()) < CONFIG.CACHE_TTL) {\n      return fm.readImage(filePath);\n    }\n  }\n\n  const req = new Request(url);\n  req.timeoutInterval = 5;\n  const img = await req.loadImage();\n  fm.writeImage(filePath, img);\n  return img;\n}\n\n\/\/ Получение полного списка игр с деталями и сортировка по скидке\nasync function getGamesList() {\n  const wishlist = await fetchWishlist();\n  const gamesPromises = wishlist.map(item => fetchGameDetails(item.appid));\n  const gamesDetails = await Promise.all(gamesPromises);\n  const games = gamesDetails.filter(details => details !== null);\n  return games.sort((a, b) => b.discount - a.discount);\n}\n\n\/\/ ======================= СОЗДАНИЕ ВИДЖЕТОВ =======================\n\n\/\/ Lock Screen Rectangular\nasync function createLockRectWidget() {\n  const widget = new ListWidget();\n  widget.backgroundColor = new Color(\"#000000\", 0);\n\n  try {\n    const games = await getGamesList();\n    const showGames = games.slice(0, 4); \/\/ Показываем максимум 4 игры\n\n    if (showGames.length === 0) {\n      const text = widget.addText(\"Нет игр\");\n      text.textColor = CONFIG.COLORS.TITLE;\n      return widget;\n    }\n\n    for (const game of showGames) {\n      const row = widget.addStack();\n      row.layoutHorizontally();\n\n      \/\/ Название игры\n      const left = row.addStack();\n      const title = left.addText(trimText(game.name, CONFIG.TRIM_LENGTHS.LOCK_RECT));\n      title.font = CONFIG.FONT_FAMILY(CONFIG.FONT_SIZES.TITLE_SMALL);\n      title.textColor = CONFIG.COLORS.TITLE;\n\n      row.addSpacer();\n\n      \/\/ Цена\n      const right = row.addStack();\n      const priceText = right.addText(game.discount > 0\n        ? `${formatPrice(game.final_price)}(-${game.discount}%)`\n        : formatPrice(game.final_price));\n      priceText.font = CONFIG.FONT_FAMILY(CONFIG.FONT_SIZES.PRICE);\n      priceText.textColor = game.discount > 0 ? CONFIG.COLORS.DISCOUNT : CONFIG.COLORS.NO_DISCOUNT;\n\n      widget.addSpacer(CONFIG.PADDING.ROW_INTERNAL);\n    }\n  } catch {\n    const text = widget.addText(\"Ошибка загрузки\");\n    text.textColor = CONFIG.COLORS.ERROR;\n  }\n\n  return widget;\n}\n\n\/\/ Lock Screen Inline\nasync function createLockInlineWidget() {\n  const widget = new ListWidget();\n  try {\n    const games = await getGamesList();\n    const topGame = games.find(g => g.discount > 0);\n\n    const text = widget.addText(topGame\n      ? `${trimText(topGame.name, CONFIG.TRIM_LENGTHS.INLINE)} -${topGame.discount}%`\n      : \"Нет скидок\");\n    text.font = CONFIG.FONT_FAMILY(CONFIG.FONT_SIZES.TITLE_INLINE);\n    text.textColor = CONFIG.COLORS.TITLE;\n  } catch {\n    const text = widget.addText(\"Ошибка\");\n    text.font = CONFIG.FONT_FAMILY(CONFIG.FONT_SIZES.TITLE_INLINE);\n    text.textColor = CONFIG.COLORS.ERROR;\n  }\n\n  return widget;\n}\n\n\/\/ Домашний виджет\nasync function createHomeWidget() {\n  const widget = new ListWidget();\n\n  \/\/ Градиентный фон Steam\n  const gradient = new LinearGradient();\n  gradient.locations = [0, 1];\n  gradient.colors = [new Color(\"#171a21\"), new Color(\"#2a475e\")];\n  widget.backgroundGradient = gradient;\n  widget.setPadding(\n    CONFIG.PADDING.TOP, CONFIG.PADDING.LEFT, \n    CONFIG.PADDING.BOTTOM, CONFIG.PADDING.RIGHT\n  );\n\n  try {\n    const games = await getGamesList();\n    const family = config.widgetFamily || \"medium\";\n    const { max: maxGames, posters: showPosters } = CONFIG.WIDGET_CONFIG[family];\n    const showGames = games.slice(0, maxGames);\n\n    for (const game of showGames) {\n      const row = widget.addStack();\n      row.layoutHorizontally();\n      row.centerAlignContent();\n\n      \/\/ Постер игры\n      if (showPosters) {\n        const img = await loadCachedImage(game.cover, `${game.id}.jpg`);\n        const cover = row.addImage(img);\n        cover.imageSize = new Size(CONFIG.POSTER.WIDTH, CONFIG.POSTER.HEIGHT);\n        cover.cornerRadius = CONFIG.POSTER.CORNER_RADIUS;\n        row.addSpacer(CONFIG.PADDING.BETWEEN_ELEMENTS);\n      }\n\n      \/\/ Название игры\n      const nameStack = row.addStack();\n      nameStack.layoutHorizontally();\n      const title = nameStack.addText(trimText(game.name, CONFIG.TRIM_LENGTHS.HOME));\n      title.textColor = CONFIG.COLORS.TITLE;\n      title.font = CONFIG.FONT_FAMILY(CONFIG.FONT_SIZES.TITLE_MEDIUM);\n      nameStack.addSpacer();\n\n      \/\/ Цена\n      const price = family === 'small' ? formatPrice(game.final_price) : game.final_price;\n      const priceText = row.addText(game.discount > 0\n        ? `${price} (-${game.discount}%)`\n        : price);\n      priceText.textColor = game.discount > 0 ? CONFIG.COLORS.DISCOUNT : CONFIG.COLORS.NO_DISCOUNT;\n      priceText.font = CONFIG.FONT_FAMILY(CONFIG.FONT_SIZES.PRICE);\n\n      widget.addSpacer(CONFIG.PADDING.BETWEEN_ROWS);\n    }\n  } catch {\n    const text = widget.addText(\"Ошибка загрузки\");\n    text.textColor = CONFIG.COLORS.ERROR;\n  }\n\n  return widget;\n}\n\n\/\/ ======================= ГЛАВНАЯ ФУНКЦИЯ =======================\nasync function createWidget() {\n  const family = config.widgetFamily;\n  switch (family) {\n    case \"accessoryRectangular\": return await createLockRectWidget();\n    case \"accessoryInline\": return await createLockInlineWidget();\n    default: return await createHomeWidget();\n  }\n}\n\n\/\/ ======================= ЗАПУСК ВИДЖЕТА =======================\nconst widget = await createWidget();\nif (config.runsInWidget) Script.setWidget(widget);\nelse widget.presentMedium();\nScript.complete();",
  "share_sheet_inputs" : [

  ]
}
